---
contentKey: chapter
title: Update Chat Screen
stepNo: 8
metaTitle: Update Chat Screen page
metaDescription: Update Chat Screen description
date: 2022-01-25T21:27:17.316Z
duration: 30 min
tags:
  - flutter
  - firebase
keywords:
  - flutter
  - firebase
---
# ðŸ—£ï¸ Update Chat Screen

Now let's finish the Chat application and save the chat message to database.

#### DataBase Service

We update our DataBaseService => **`database_service.dart`** to getChatMessages and sendChatMessage

```
 Future<List<Message>> getChatMessages(
      String senderId, String receiverId) async {
    List<Message> messages = [];
    QuerySnapshot messagesSenderQuerySnapshot = await chatsRef
        .where('senderId', isEqualTo: senderId)
        .where('toUserId', isEqualTo: receiverId)
        .orderBy('timestamp', descending: true)
        .get();

    for (var doc in messagesSenderQuerySnapshot.docs) {
      // ignore: avoid_print
      print(doc.id);
      messages.add(Message.fromDoc(doc));
    }
    QuerySnapshot messagestoQuerySnapshot = await chatsRef
        .where('senderId', isEqualTo: receiverId)
        .where('toUserId', isEqualTo: senderId)
        .orderBy('timestamp', descending: true)
        .get();

    for (var doc in messagestoQuerySnapshot.docs) {
      // ignore: avoid_print
      print(doc.id);
      messages.add(Message.fromDoc(doc));
    }

    Comparator<Message> timestampComparator =
        (a, b) => b.timestamp!.compareTo(a.timestamp!);
    messages.sort(timestampComparator);
    return messages;
  }

  void sendChatMessage(Message message) {
    chatsRef.add({
      'senderId': message.senderId,
      'toUserId': message.toUserId,
      'text': message.text,
      'imageUrl': message.imageUrl,
      'isLiked': message.isLiked,
      'unread': message.unread,
      'timestamp': Timestamp.fromDate(DateTime.now()),
    });
  }
```

#### Update Message Model

We need toÂ  update our message model, and introduce from sender and to sender and new fields, also it will have a function that maps database values with object.

```
class Message {

Â Â final String id, senderId, toUserId, text, imageUrl;

Â Â final bool isLiked;

Â Â final bool unread;

Â Â final Timestamp timestamp;

Â 

Â Â Message({

Â Â Â Â this.id,

Â Â Â Â this.senderId,

Â Â Â Â this.toUserId,

Â Â Â Â this.text,

Â Â Â Â this.imageUrl,

Â Â Â Â this.isLiked,

Â Â Â Â this.unread,

Â Â Â Â this.timestamp,

Â Â });

Â 

Â Â factory Message.fromDoc(DocumentSnapshot doc) {

Â Â Â Â return Message(

Â Â Â Â Â Â Â Â id: doc.documentID,

Â Â Â Â Â Â Â Â senderId: doc\['senderId'],

Â Â Â Â Â Â Â Â toUserId: doc\['toUserId'],

Â Â Â Â Â Â Â Â text: doc\['text'],

Â Â Â Â Â Â Â Â imageUrl: doc\['imageUrl'],

Â Â Â Â Â Â Â Â isLiked: doc\['isLiked'],

Â Â Â Â Â Â Â Â unread: doc\['unread'],

Â Â Â Â Â Â Â Â timestamp: doc\['timestamp']);

Â Â }

}
```

We will add dateFormat to our constants.dart ðŸ“„ file

```
final DateFormat timeFormat =DateFormat('E, h:mm a');
```

To get the dateformat import package - intl - pubspec.yaml

> `intl: ^0.16.1`

#### Refactor Chat Screen

That chat_screen.dart will need to take 2 parameters, from which user message is coming from and to sender.

```
final String currentUserId;

Â final String toUserId;

Â 

Â ChatScreen({this.currentUserId, this.toUserId});
```

We need to bring messages from our database.

`Delete`

```
Â final List<Message> _messages = messages;
```

`And add`

```
DataBaseService _dataBaseService;

Â List<Message> _messages = \[];

Â 

Â @override

Â void initState() {

Â Â Â super.initState();

Â Â Â Â Â _dataBaseService = Provider.of<DataBaseService>(context, listen: false);

Â 

Â Â Â _setupMessages();

Â }

Â 

Â _setupMessages() async {

Â Â Â List<Message> messages = await _dataBaseService.getChatMessages(

Â Â Â Â Â Â Â widget.currentUserId, widget.toUserId);

Â Â Â setState(() {

Â Â Â Â Â _messages = messages;

Â Â Â });

Â }
```

Update message time with

```
Â Â Text(

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â '${timeFormat.format(message.timestamp.toDate())}',
```

In the Â `void _handleSubmitted(String` , update code to pass new values and call the database service

```
void _handleSubmitted(String text) {

Â Â Â _textMessageController.clear();

Â 

Â Â Â setState(() {

Â Â Â Â Â _isComposing = false;

Â Â Â });

Â Â Â Message message = Message(

Â Â Â Â Â senderId: widget.currentUserId,

Â Â Â Â Â toUserId: widget.toUserId,

Â Â Â Â Â timestamp: Timestamp.fromDate(DateTime.now()),

Â Â Â Â Â text: text,

Â Â Â Â Â isLiked: true,

Â Â Â Â Â unread: true,

Â Â Â );

Â Â Â setState(() {

Â Â Â Â Â _messages.insert(0, message);

Â Â Â });

Â Â Â Â Â Â Â _dataBaseService.sendChatMessage(message);

Â 

Â }
```

And finally update the `isMe`code to get value from the widget

```
final bool isMe = message.senderId == widget.currentUserId;
```

Chat screen is called through the attendees screen.

#### Update all_attendees_widget

So update the all_attendees_widget.dart

In the build get the current user id

```
Widget build(BuildContext context) {

Â Â Â Â Â Â Â String currentUserId =

Â Â Â Â Â Â Â Provider.of<UserData>(context, listen: false).currentUserId;
```

And pass it to the chatscreen

```
return GestureDetector(

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â onTap: () => Navigator.push(

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â context,

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â MaterialPageRoute(

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â builder: (_) => ChatScreen(

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â currentUserId: currentUserId,

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â toUserId: user.id,

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ),

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ),

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ),
```

![](https://lh4.googleusercontent.com/KrQ0Q44DBwIwR9TI3vDFWrZ8dJwtNT3NVuaPbYh_JdNEi4iNMukWLCpTP8VS5kHfPEY5fTgzIYyWorlWbpL_g4sUGqkl6LGKjdvlxJBnVD-ZWhJwaiFgBg-jiHNPd2aForffvaQ7)

## Step 6 -Sending Picture Messages

We would also like to send pictures in the chat.

In our storage_service.dart we will add a new function uploadMessageImage

```
Future<String> uploadMessageImage(File imageFile) async {

Â Â Â String imageId = Uuid().v4();

Â Â Â File image = await compressImage(imageId, imageFile);

Â 

Â Â Â String downloadUrl = await _uploadImage(

Â Â Â Â Â 'images/messages/message_$imageId.jpg',

Â Â Â Â Â imageId,

Â Â Â Â Â image,

Â Â Â );

Â Â Â return downloadUrl;

Â }
```

In chat_screen.dart we update _buildMessage

And check if message.imageurl == null and removeÂ  Text(Â  Â  Â  Â  Â  Â  Â  message.text, â€¦

```
Â Â Â children: <Widget>[

Â Â Â Â Â Â Â Â Â Â Â message.imageUrl == null

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ? _buildText(isMe, message)

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â : _buildImage(context, message),

Â Â Â Â Â Â Â Â Â Â Â SizedBox(height: 8.0),
```

Add the new methods before build

```
_buildText(bool isMe,Message message) {

Â Â Â return Text(

Â Â Â Â Â Â Â Â Â Â Â Â Â message.text,

Â Â Â Â Â Â Â Â Â Â Â Â Â style: TextStyle(

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â color: isMe ? Colors.white60 : Colors.blueGrey,

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â fontSize: 12.0,

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â fontWeight: FontWeight.w600,

Â Â Â Â Â Â Â Â Â Â Â Â Â ),

Â Â Â Â Â Â Â Â Â Â Â );

Â }

_buildImage(BuildContext context,Message message) {

Â Â Â final size = MediaQuery.of(context).size;

Â Â Â return Container(

Â Â Â Â Â height: size.height * 0.2,

Â Â Â Â Â width: size.width * 0.6,

Â Â Â Â Â decoration: BoxDecoration(

Â Â Â Â Â Â Â Â Â borderRadius: BorderRadius.circular(20.0),

Â Â Â Â Â Â Â Â Â image: DecorationImage(

Â Â Â Â Â Â Â Â Â Â Â fit: BoxFit.cover,

Â Â Â Â Â Â Â Â Â Â Â image: CachedNetworkImageProvider(message.imageUrl),

Â Â Â Â Â Â Â Â Â )),

Â Â Â );

Â }
```

Add to onPressed of our camera icon

```
children: <Widget>[

Â Â Â Â Â Â Â Â Â RawMaterialButton(

Â Â Â Â Â Â Â Â Â Â Â onPressed: () async {

Â Â Â Â Â Â Â Â Â Â Â Â Â File imageFile = await ImagePicker.pickImage(

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â source: ImageSource.gallery,

Â Â Â Â Â Â Â Â Â Â Â Â Â );

Â Â Â Â Â Â Â Â Â Â Â Â Â if (imageFile != null) {

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â String imageUrl =

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â await Provider.of<StorageService>(context, listen: false)

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â .uploadMessageImage(imageFile);

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â _handleSubmitted(null, imageUrl);

Â Â Â Â Â Â Â Â Â Â Â Â Â }

Â Â Â Â Â Â Â Â Â Â Â },
```

Update _handleSubmitted to take additional parameter

```
void _handleSubmitted(String text, String imageUrl) {

Â Â Â if ((text != null && text.trim().isNotEmpty) || imageUrl != null) {

Â Â Â Â Â if (imageUrl == null) {

Â Â Â Â Â Â Â //text message

Â 

Â Â Â Â Â Â Â setState(() {

Â Â Â Â Â Â Â Â Â _isComposing = false;

Â Â Â Â Â Â Â });

Â Â Â Â Â }

Â Â Â Â Â Message message = Message(

Â Â Â Â Â Â Â senderId: widget.currentUserId,

Â Â Â Â Â Â Â toUserId: widget.toUserId,

Â Â Â Â Â Â Â imageUrl: imageUrl,

Â Â Â Â Â Â Â timestamp: Timestamp.fromDate(DateTime.now()),

Â Â Â Â Â Â Â text: text,

Â Â Â Â Â Â Â isLiked: true,

Â Â Â Â Â Â Â unread: true,

Â Â Â Â Â );

Â Â Â Â Â setState(() {

Â Â Â Â Â Â Â _messages.insert(0, message);

Â Â Â Â Â });

Â Â Â Â Â _dataBaseService.sendChatMessage(message);

Â Â Â }

Â }
```

Â And update its usages.

```
onPressed: _isComposing

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ? () => _handleSubmitted(

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â _textMessageController.text,

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â null,

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â )

Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â : null,
```

Finally add Provider for StorageService in main.dart

```
Provider<StorageService>(

Â Â Â Â Â create: (_) => StorageService(),

Â Â Â ),
```